<!DOCTYPE html><html lang=en><meta charset=utf8><title>unified</title><meta name=viewport content=width=device-width,initial-scale=1><link href=index.css rel=stylesheet><header><h1><a href=..><span class="hl unified">uni</span>fied</a></h1></header><main><section><h2 id=creating-an-editor><a class=anchor href=#creating-an-editor>#</a>Creating an editor</h2><blockquote><p>I’m not entirely sure how to call this thing. “Demo” is too generic, “dingus” too vague, and I think editor is pretty apt. Anyway, drop a line on <a href=https://gitter.im/unifiedjs/Lobby>Gitter</a> if you know a better name.</blockquote><p>This guide shows how to create an interactive online editor with unified. In it we’ll visualise syntactic properties of text by “syntax highlighting” them. The editor will run in a browser. It’ll be fast as we’re using <a href=https://github.com/Matt-Esch/virtual-dom><code>virtual-dom</code></a> (but you could use <a href=https://facebook.github.io/react/>React</a> and the like too).<p>For this example we’ll create an app that visualises sentence length. It’s based on a tip by <a href=http://www.garyprovost.com/_i__b__font_size___1__100_ways_to_improve_your_writing___font_size__font_size__2_109049.htm>Gary Provost</a>, and the visualisation is based on <a href=https://twitter.com/gregoryciotti/status/639837682844090369>a tweet by @gregoryciotti</a>.<p>You can also <a href=http://wooorm.com/write-music/>view this project</a> with some more features online.<blockquote><p>Stuck? A good place to get help fast is <a href=https://gitter.im/unifiedjs/Lobby>Gitter</a>. Have an idea for another guide? Share it on Gitter!</blockquote><article><h3 id=contents><a class=anchor href=#contents>#</a>Contents</h3><ul><li><a href=#case>Case</a><li><a href=#project-structure>Project structure</a><li><a href=#setting-up-javascript>Setting up JavaScript</a><li><a href=#natural-language-syntax-tree>Natural language syntax tree</a><li><a href=#virtual-dom>Virtual DOM</a><li><a href=#highlight>Highlight</a><li><a href=#colour>Colour</a><li><a href=#squashing-bugs>Squashing bugs</a><li><a href=#further-exercises>Further exercises</a></ul></article><article><h3 id=case><a class=anchor href=#case>#</a>Case</h3><p>Before we start, let’s first outline what we want to make. We want to highlight sentences in text based on how many words they have. The user should be able to change text, and it should highlight live.<p>We’ll use <a href=https://github.com/sindresorhus/xo>xo</a> as a linter, and <a href=https://github.com/substack/node-browserify>browserify</a> as a bundler to compile our JavaScript with <code>require</code> calls to JavaScript that works in the browser (you could of course swap those out for your favourite linter and bundler).</article><article><h3 id=project-structure><a class=anchor href=#project-structure>#</a>Project structure</h3><p>Let’s first outline our project structure:<pre><code class=language-txt>demo/
├─ index.js
├─ build.js
├─ index.html
├─ index.css
└─ package.json
</code></pre><p>...where <code>demo/</code> is our directory, and <code>build.js</code> is the JavaScript generated by compiling <code>index.js</code>.<p>Keep <code>index.js</code>, <code>index.html</code>, and <code>index.css</code> empty for now, and fill <code>package.json</code> with the following.<figure class="gist window"><figcaption>package.json</figcaption><pre><code class=language-json>{
  <span class=hljs-attr>"name"</span>: <span class=hljs-string>"demo"</span>,
  <span class=hljs-attr>"private"</span>: <span class=hljs-literal>true</span>,
  <span class=hljs-attr>"dependencies"</span>: {},
  <span class=hljs-attr>"devDependencies"</span>: {
    <span class=hljs-attr>"browserify"</span>: <span class=hljs-string>"^15.0.0"</span>,
    <span class=hljs-attr>"xo"</span>: <span class=hljs-string>"^0.18.0"</span>
  },
  <span class=hljs-attr>"scripts"</span>: {
    <span class=hljs-attr>"build"</span>: <span class=hljs-string>"browserify index.js > build.js"</span>,
    <span class=hljs-attr>"lint"</span>: <span class=hljs-string>"xo"</span>,
    <span class=hljs-attr>"test"</span>: <span class=hljs-string>"npm run build &amp&amp npm run lint"</span>
  },
  <span class=hljs-attr>"xo"</span>: {
    <span class=hljs-attr>"space"</span>: <span class=hljs-literal>true</span>,
    <span class=hljs-attr>"esnext"</span>: <span class=hljs-literal>false</span>,
    <span class=hljs-attr>"envs"</span>: [
      <span class=hljs-string>"browser"</span>
    ],
    <span class=hljs-attr>"ignore"</span>: [
      <span class=hljs-string>"build.js"</span>
    ]
  }
}</code></pre></figure><blockquote><p><a href=https://docs.npmjs.com/files/package.json#private><code>private: true</code></a> means you can’t accidentally publish your package to npm.</blockquote><p>Now, after running <code>npm install</code> and <code>npm test</code> you’ll see <code>build.js</code> appear too. The above package sets up <a href=https://github.com/sindresorhus/xo>xo</a> as the linter and <a href=https://github.com/substack/node-browserify>browserify</a> as the bundler.<p>Now, fill <code>index.html</code> with the following:<figure class="gist window"><figcaption>index.html</figcaption><pre><code class=language-html><span class=hljs-meta>&lt;!doctype html></span>
<span class=hljs-tag>&lt;<span class=hljs-name>meta</span> <span class=hljs-attr>charset</span>=<span class=hljs-string>"utf8"</span>></span>
<span class=hljs-tag>&lt;<span class=hljs-name>title</span>></span>demo<span class=hljs-tag>&lt;/<span class=hljs-name>title</span>></span>
<span class=hljs-tag>&lt;<span class=hljs-name>link</span> <span class=hljs-attr>rel</span>=<span class=hljs-string>"stylesheet"</span> <span class=hljs-attr>href</span>=<span class=hljs-string>"index.css"</span>></span>
<span class=hljs-tag>&lt;<span class=hljs-name>div</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"root"</span>></span><span class=hljs-tag>&lt;/<span class=hljs-name>div</span>></span>
<span class=hljs-tag>&lt;<span class=hljs-name>script</span> <span class=hljs-attr>src</span>=<span class=hljs-string>"build.js"</span>></span><span class=null></span><span class=hljs-tag>&lt;/<span class=hljs-name>script</span>></span></code></pre></figure><p>This links <code>index.css</code> and <code>build.js</code>, and adds an element (<code>#root</code>) which we’ll add our editor to later. Oh, did you know that <code>&lt;html></code>, <code>&lt;head></code>, and <code>&lt;body></code> are optional? For this example we’ll keep the HTML clean, but feel free to add them if you prefer them.</article><article><h3 id=setting-up-javascript><a class=anchor href=#setting-up-javascript>#</a>Setting up JavaScript</h3><p>Alright! Now, let’s set up our JavaScript. Start by adding the following to <code>index.js</code>:<figure class="gist window"><figcaption>index.js</figcaption><pre><code class=language-js><span class=hljs-keyword>var</span> h = <span class=hljs-built_in>require</span>(<span class=hljs-string>'virtual-dom/h'</span>);
<span class=hljs-keyword>var</span> createElement = <span class=hljs-built_in>require</span>(<span class=hljs-string>'virtual-dom/create-element'</span>);
<span class=hljs-keyword>var</span> diff = <span class=hljs-built_in>require</span>(<span class=hljs-string>'virtual-dom/diff'</span>);
<span class=hljs-keyword>var</span> patch = <span class=hljs-built_in>require</span>(<span class=hljs-string>'virtual-dom/patch'</span>);

<span class=hljs-keyword>var</span> root = <span class=hljs-built_in>document</span>.getElementById(<span class=hljs-string>'root'</span>);
<span class=hljs-keyword>var</span> tree = render(<span class=hljs-string>'The initial text.'</span>);
<span class=hljs-keyword>var</span> dom = root.appendChild(createElement(tree));

<span class=hljs-function><span class=hljs-keyword>function</span> <span class=hljs-title>onchange</span>(<span class=hljs-params>ev</span>) </span>{
  <span class=hljs-keyword>var</span> next = render(ev.target.value);
  dom = patch(dom, diff(tree, next));
  tree = next;
}

<span class=hljs-function><span class=hljs-keyword>function</span> <span class=hljs-title>render</span>(<span class=hljs-params>text</span>) </span>{
  <span class=hljs-keyword>var</span> node = parse(text);

  <span class=hljs-keyword>return</span> h(<span class=hljs-string>'div'</span>, {<span class=hljs-attr>className</span>: <span class=hljs-string>'editor'</span>}, [
    h(<span class=hljs-string>'div'</span>, {<span class=hljs-attr>key</span>: <span class=hljs-string>'draw'</span>, <span class=hljs-attr>className</span>: <span class=hljs-string>'draw'</span>}, highlight(node)),
    h(<span class=hljs-string>'textarea'</span>, {
      <span class=hljs-attr>key</span>: <span class=hljs-string>'area'</span>,
      <span class=hljs-attr>value</span>: text,
      <span class=hljs-attr>oninput</span>: onchange
    })
  ]);

  <span class=hljs-function><span class=hljs-keyword>function</span> <span class=hljs-title>parse</span>(<span class=hljs-params></span>) </span>{}

  <span class=hljs-function><span class=hljs-keyword>function</span> <span class=hljs-title>highlight</span>(<span class=hljs-params></span>) </span>{}
}</code></pre></figure><blockquote><p>Don’t forget to <code>npm install --save virtual-dom</code>.</blockquote><p>That’s going a bit fast, I can imagine, if you’ve never seen <a href=https://github.com/Matt-Esch/virtual-dom><code>virtual-dom</code></a> in use before. If that’s the case, please take some time to peruse the <code>virtual-dom</code> docs at your leisure. This guide will wait!<p>To summarise what all these things in the code mean:<ul><li><code>h</code> creates “virtual” nodes<li><code>createElement</code> turns them into DOM nodes<li><code>diff</code> finds the difference between two virtual nodes<li><code>patch</code> applies <code>diff</code> to a DOM node<li><code>root</code> is our anchor into the document<li><code>tree</code> is the current virtual tree<li><code>dom</code> is the current DOM tree<li><code>onchange</code> handles any state change (the text in our case)<li><code>render</code> creates a new virtual tree based on that state<li><code>parse</code> transforms the state into a natural language syntax tree<li><code>highlight</code> transforms that syntax tree into a virtual tree</ul><p>In <code>render</code>, we’re creating two elements: a <code>&lt;div></code> that we’ll draw our syntax highlighting in, and a <code>&lt;textarea></code> that the user can edit. Both are wrapped in a parent <code>&lt;div></code>. We’ll style the text area and the drawing area exactly the same, and position the text above the drawing area, with the following styles.<figure class="gist window"><figcaption>index.css</figcaption><pre><code class=language-css><span class=hljs-selector-tag>html</span> {
  <span class=hljs-attribute>font-size</span>: <span class=hljs-number>16px</span>;
  <span class=hljs-attribute>line-height</span>: <span class=hljs-number>1.5</span>;
}

<span class=hljs-selector-class>.editor</span> {
  <span class=hljs-attribute>position</span>: relative;
  <span class=hljs-attribute>max-width</span>: <span class=hljs-number>37em</span>;
  <span class=hljs-attribute>margin</span>: auto;
  <span class=hljs-attribute>overflow</span>: hidden;
}

<span class=hljs-selector-tag>textarea</span>, <span class=hljs-selector-class>.draw</span> {
  <span class=hljs-attribute>margin</span>: <span class=hljs-number>0</span>;
  <span class=hljs-attribute>padding</span>: <span class=hljs-number>0</span>;
  <span class=hljs-attribute>width</span>: <span class=hljs-number>100%</span>;
  <span class=hljs-attribute>border</span>: none;
  <span class=hljs-attribute>outline</span>: none;
  <span class=hljs-attribute>resize</span>: none;
  <span class=hljs-attribute>overflow</span>: hidden;
  <span class=hljs-comment>/* Can’t use a nice font: kerning renders differently in textareas. */</span>
  <span class=hljs-attribute>font-family</span>: monospace;
  <span class=hljs-attribute>line-height</span>: inherit;
  <span class=hljs-attribute>font-size</span>: inherit;
  <span class=hljs-attribute>background</span>: transparent;
  <span class=hljs-attribute>white-space</span>: pre-wrap;
  <span class=hljs-attribute>word-wrap</span>: break-word;
  <span class=hljs-attribute>font-size</span>: inherit;
  <span class=hljs-attribute>line-height</span>: inherit;
}

<span class=hljs-selector-tag>textarea</span> {
  <span class=hljs-attribute>color</span>: inherit;
  <span class=hljs-attribute>position</span>: absolute;
  <span class=hljs-attribute>top</span>: <span class=hljs-number>0</span>;
}

<span class=hljs-selector-class>.draw</span> {
  <span class=hljs-attribute>min-height</span>: <span class=hljs-number>100vh</span>;
}</code></pre></figure><p>That’s quite a bit of code: mainly to enforce the same styles on our text and drawing areas.</article><article><h3 id=natural-language-syntax-tree><a class=anchor href=#natural-language-syntax-tree>#</a>Natural language syntax tree</h3><p>Now, let’s set up our natural language syntax tree parsing. We’ll of course use unified, and <a href=https://github.com/retextjs/retext/tree/master/packages/retext-english><code>retext-english</code></a> to parse English natural language.<p>Change <code>index.js</code> like so:<figure class="gist window"><figcaption>index.js</figcaption><pre><code class=language-diff>@@ -2,7 +2,10 @@ var h = require('virtual-dom/h');
 var createElement = require('virtual-dom/create-element');
 var diff = require('virtual-dom/diff');
 var patch = require('virtual-dom/patch');
<span class=hljs-addition>var unified = require('unified');</span>
<span class=hljs-addition>var english = require('retext-english');</span>

<span class=hljs-addition>var processor = unified().use(english);</span>
 var root = document.getElementById('root');
 var tree = render('The initial text.');
 var dom = root.appendChild(createElement(tree));
@@ -25,7 +28,9 @@ function render(text) {
     })
   ]);

<span class=hljs-deletion>  function parse() {}</span>
<span class=hljs-addition>  function parse(value) {</span>
<span class=hljs-addition>    return processor.runSync(processor.parse(value));</span>
<span class=hljs-addition>  }</span>

   function highlight() {}
 }</code></pre></figure><blockquote><p>Don’t forget to <code>npm install --save unified retext-english</code>.</blockquote><p>Sweet, now we have access to a lot of info on the text. It still doesn’t do anything yet though. Let’s add some usefulness.</article><article><h3 id=virtual-dom><a class=anchor href=#virtual-dom>#</a>Virtual DOM</h3><p>Our next task is to go from a natural language syntax tree to a virtual DOM. We already have <code>highlight</code> for that, but it’s empty, so let’s add code to fill it:<figure class="gist window"><figcaption>index.js</figcaption><pre><code class=language-diff>@@ -32,5 +32,21 @@ function render(text) {
     return processor.runSync(processor.parse(value));
   }

<span class=hljs-deletion>  function highlight() {}</span>
<span class=hljs-addition>  function highlight(node) {</span>
<span class=hljs-addition>    var children = node.children;</span>
<span class=hljs-addition>    var length = children.length;</span>
<span class=hljs-addition>    var index = -1;</span>
<span class=hljs-addition>    var results = [];</span>
<span class=hljs-addition></span>
<span class=hljs-addition>    while (++index &lt; length) {</span>
<span class=hljs-addition>      results = results.concat(one(children[index]));</span>
<span class=hljs-addition>    }</span>
<span class=hljs-addition></span>
<span class=hljs-addition>    return results;</span>
<span class=hljs-addition>  }</span>
<span class=hljs-addition></span>
<span class=hljs-addition>  function one(node) {</span>
<span class=hljs-addition>    var result = 'value' in node ? node.value : highlight(node);</span>
<span class=hljs-addition>    return result;</span>
<span class=hljs-addition>  }</span>
 }</code></pre></figure><p><code>highlight</code> searches all children in the given <code>node</code>, and <code>one</code> returns either the “text content” of a node, or the result of searching its children for text content.<p>If you’d now run <code>npm test</code> again, and open <code>index.html</code> in your browser, you’ll see that the drawing area already has our text (it’s hidden with styles, but you should be able to see it in your web inspector).<p>We need one more thing before we can start highlighting: we need to detect sentences, and apply styles to them. Change <code>index.js</code> like so:<figure class="gist window"><figcaption>index.js</figcaption><pre><code class=language-diff>@@ -18,6 +18,7 @@ function onchange(ev) {

 function render(text) {
   var node = parse(text);
<span class=hljs-addition>  var key = 0;</span>

   return h('div', {className: 'editor'}, [
     h('div', {key: 'draw', className: 'draw'}, highlight(node)),
@@ -47,6 +48,19 @@ function render(text) {

   function one(node) {
     var result = 'value' in node ? node.value : highlight(node);
<span class=hljs-addition></span>
<span class=hljs-addition>    if (node.type === 'SentenceNode') {</span>
<span class=hljs-addition>      key++;</span>
<span class=hljs-addition>      result = h('span', {</span>
<span class=hljs-addition>        key: 's-' + key,</span>
<span class=hljs-addition>        style: {backgroundColor: color(count(node))}</span>
<span class=hljs-addition>      }, result);</span>
<span class=hljs-addition>    }</span>
<span class=hljs-addition></span>
     return result;
   }
<span class=hljs-addition></span>
<span class=hljs-addition>  function count() {}</span>
<span class=hljs-addition></span>
<span class=hljs-addition>  function color() {}</span>
 }</code></pre></figure><blockquote><p><code>key</code> is needed for <code>virtual-dom</code> <a href=https://github.com/Matt-Esch/virtual-dom/tree/master/virtual-hyperscript#key>to be performant</a>.</blockquote><p>We don’t colour sentences yet, but there’s <code>&lt;span></code> elements wrapping them now. You can see that in action by running <code>npm test</code> again and using your web inspector to inspect the drawing area.<p>We’ve also set up two functions to highlight sentences. <code>count</code> will count the number of words of a given sentence, and <code>color</code> will pick a corresponding colour.</article><article><h3 id=highlight><a class=anchor href=#highlight>#</a>Highlight</h3><p>Now, let’s add colours. Update <code>index.js</code> like so:<figure class="gist window"><figcaption>index.js</figcaption><pre><code class=language-diff>@@ -4,6 +4,11 @@ var diff = require('virtual-dom/diff');
 var patch = require('virtual-dom/patch');
 var unified = require('unified');
 var english = require('retext-english');
<span class=hljs-addition>var visit = require('unist-util-visit');</span>
<span class=hljs-addition></span>
<span class=hljs-addition>var hues = [</span>
<span class=hljs-addition>  0</span>
<span class=hljs-addition>];</span>

 var processor = unified().use(english);
 var root = document.getElementById('root');
@@ -60,7 +65,20 @@ function render(text) {
     return result;
   }

<span class=hljs-deletion>  function count() {}</span>
<span class=hljs-addition>  function count(node) {</span>
<span class=hljs-addition>    var value = 0;</span>
<span class=hljs-addition></span>
<span class=hljs-addition>    visit(node, 'WordNode', add);</span>

<span class=hljs-addition>    return value;</span>
<span class=hljs-addition></span>
<span class=hljs-addition>    function add() {</span>
<span class=hljs-addition>      value++;</span>
<span class=hljs-addition>    }</span>
<span class=hljs-addition>  }</span>
<span class=hljs-addition></span>
<span class=hljs-deletion>  function color() {}</span>
<span class=hljs-addition>  function color(count) {</span>
<span class=hljs-addition>    var val = count &lt; hues.length ? hues[count] : hues[hues.length - 1];</span>
<span class=hljs-addition>    return 'hsl(' + [val, '93%', '85%'].join(', ') + ')';</span>
<span class=hljs-addition>  }</span>
 }</code></pre></figure><blockquote><p>Don’t forget to <code>npm install --save unist-util-visit</code>.</blockquote><p>The <code>count</code> function searches <code>node</code> for all occurrences of words, through <a href=https://github.com/syntax-tree/unist-util-visit><code>unist-util-visit</code></a>, and returns that count.<p><code>color</code> takes a number, and returns a nice colour in <abbr class=first title="Hue Saturation Lightness">HSL</abbr> for it. It does so based on if there’s a corresponding hue for it in <code>hues</code> (now just one value). If there’s no corresponding hue, it uses the last specified hue.<p>It’s not much, but it’s something. Try it out by running <code>npm test</code> again, and viewing <code>index.html</code> in your browser. If everything went okay, you should see each sentence highlighted in red.</article><article><h3 id=colour><a class=anchor href=#colour>#</a>Colour</h3><p>One colour isn’t that cool, and we’re trying to recreate that <a href=https://twitter.com/gregoryciotti/status/639837682844090369>visualisation by @gregoryciotti</a>. We need some more colours. From that image, I deducted the following hues. But you could of course use any hues you like!<p>To match that image, change <code>hues</code> like so:<figure class="gist window"><figcaption>index.js</figcaption><pre><code class=language-diff>@@ -7,7 +7,20 @@ var english = require('retext-english');
 var visit = require('unist-util-visit');

 var hues = [
<span class=hljs-addition>  60,</span>
<span class=hljs-addition>  60,</span>
<span class=hljs-addition>  60,</span>
<span class=hljs-addition>  300,</span>
<span class=hljs-addition>  300,</span>
   0,
<span class=hljs-addition>  0,</span>
<span class=hljs-addition>  120,</span>
<span class=hljs-addition>  120,</span>
<span class=hljs-addition>  120,</span>
<span class=hljs-addition>  120,</span>
<span class=hljs-addition>  120,</span>
<span class=hljs-addition>  120,</span>
<span class=hljs-addition>  180</span>
 ];

 var processor = unified().use(english);</code></pre></figure></article><article><h3 id=squashing-bugs><a class=anchor href=#squashing-bugs>#</a>Squashing bugs</h3><p>💃 After running <code>npm test</code> again, and reopening <code>index.html</code> in your browser, you should now see <code>The initial text</code> in purple! If you add more sentences, they each should receive colours based on how many words they have.<p>If you add more text, you’ll notice that our drawing area grows nicely, but our text area does not. That’s because this example positions the <code>&lt;textarea></code> absolutely on top of the drawing area. The easiest way to get both areas the same height, is with the following slightly hacky code:<figure class="gist window"><figcaption>index.js</figcaption><pre><code class=language-diff>@@ -28,10 +28,13 @@ var root = document.getElementById('root');
 var tree = render('The initial text.');
 var dom = root.appendChild(createElement(tree));

<span class=hljs-addition>setTimeout(resize, 4);</span>
<span class=hljs-addition></span>
 function onchange(ev) {
   var next = render(ev.target.value);
   dom = patch(dom, diff(tree, next));
   tree = next;
<span class=hljs-addition>  setTimeout(resize, 4);</span>
 }

 function render(text) {
@@ -95,3 +98,10 @@ function render(text) {
     return 'hsl(' + [val, '93%', '85%'].join(', ') + ')';
   }
 }
<span class=hljs-addition></span>
<span class=hljs-addition>function resize() {</span>
<span class=hljs-addition>  dom.lastChild.rows = Math.ceil(</span>
<span class=hljs-addition>    dom.firstChild.getBoundingClientRect().height /</span>
<span class=hljs-addition>    parseInt(window.getComputedStyle(dom.firstChild).lineHeight, 10)</span>
<span class=hljs-addition>  ) + 1;</span>
<span class=hljs-addition>}</span></code></pre></figure><p>This updates the <code>rows</code> attribute on the text area to correspondent with the size of the drawing area.</article><article><h3 id=further-exercises><a class=anchor href=#further-exercises>#</a>Further exercises</h3><p>The above code has a few issues:<ul><li class=task-list-item><input type=checkbox disabled> <code>onchange</code> is not <a href=https://www.npmjs.com/package/debounce>debounced</a>, which leads to performance issues<li class=task-list-item><input type=checkbox disabled> <code>input</code> events are not supported in some older browsers<li class=task-list-item><input type=checkbox disabled> The styles aren’t perfect<li class=task-list-item><input type=checkbox disabled> and probably some other things!</ul><p>...maybe you could solve some? Other than those issues, it’s a pretty cool little demo.<p>If you haven’t already, check out the other <a href=/#guides>guides</a>!</article></section></main><footer><p>made by <a href=https://github.com/wooorm>@wooorm</a> and <a href=https://github.com/unifiedjs/unifiedjs.github.io/graphs/contributors>contributors</a><p>view the project on <a href=https://github.com/unifiedjs/unified>GitHub</a><p><a href=https://github.com/unifiedjs/unifiedjs.github.io>fork this site</a><p>☔</footer><script src=index.js></script>